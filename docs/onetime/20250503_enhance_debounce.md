# テキスト類似度ベースdebounce機能の実装

## 背景

- **現状の課題**：
  - エージェントがMCPサーバーにテキストを送る際に、指示に反して勝手に内容を加工することがある
  - 現在のdebounce機能は**完全一致**のテキストのみ検出するため、わずかな変更があると重複投稿を許してしまう
  - 結果として、同じような内容の投稿が短時間に複数回行われる問題が発生している

- **ユーザー体験の問題**：
  - エージェントの自動テキスト加工により、意図せず似たような内容の投稿が複数回行われる
  - 現状の厳格なdebounceチェックではこの問題を解決できていない

## 修正の方向性

- **類似度ベースのdebounce機能**：
  - 編集距離（レーベンシュタイン距離）を使用したテキスト類似度の計算導入
  - 90%以上の類似度を持つテキストを同一と見なす閾値の設定
  - 短時間内の類似テキスト投稿をブロックする機能

## 考慮すべき点

1. **設定の柔軟性**：
   - 類似度の閾値（90%など）を設定可能にする
   - debounceの時間間隔も調整できるようにする

2. **パフォーマンス**：
   - レーベンシュタイン距離の計算は計算量が多い（O(n*m)）
   - 長文テキストや多数の投稿の場合、最適化が必要になる可能性

3. **システムリソース**：
   - 過去テキストの保存と比較による影響（メモリ使用量など）
   - 古いエントリの効率的な管理とクリーンアップ

4. **バランス**：
   - 厳しすぎる類似度検出で正当な投稿をブロックしない
   - 緩すぎる検出で重複投稿を許さない

5. **実装の現代化**：
   - Go 1.21以降の標準ライブラリ機能（min/max関数など）の活用
   - テスト容易性の確保

## 実装ステップ

1. **現状コードの分析と理解**：
   - 現在のdebounce実装を確認（utils.goのisDebounced関数）
   - エントリの保存・管理方法の把握

2. **設定管理の構造体作成**：
   - `DebounceConfig`構造体の設計と実装
   - 時間間隔と類似度閾値を設定できるよう構造化

3. **レーベンシュタイン距離の実装**：
   - 文字列間の編集距離を計算する関数を実装
   - Go 1.21の標準min/max関数を活用

4. **テキスト類似度計算機能の追加**：
   - 編集距離から0.0〜1.0の類似度を計算する関数を実装
   - 1.0を完全一致、0.0を完全不一致とするスケール設定

5. **isDebounced関数の拡張**：
   - 完全一致チェックに加え、類似度チェックを追加
   - 設定された閾値以上の類似度を持つテキストをブロック

6. **設定変更インターフェースの追加**：
   - デバウンス時間や類似度閾値を変更する関数の実装
   - 適切なアクセス制御（mutex等）の導入

7. **単体テスト実装**：
   - 類似度計算の精度を検証するテスト
   - 様々なケースでのデバウンス処理テスト
   - エッジケース（空文字列、非常に長いテキスト等）の検証

8. **性能テストとチューニング**：
   - 長文や多数のエントリでのパフォーマンス検証
   - 必要に応じたアルゴリズム最適化や早期リターン導入

9. **エラーメッセージの改善**：
   - ユーザーにわかりやすいエラーメッセージへ更新
   - 類似度ベースでブロックされた場合の説明追加

10. **リリースと運用観察**：
    - 実際の使用状況での有効性検証
    - フィードバックに基づく閾値の微調整

## 期待される効果

- エージェントのテキスト加工に影響されない安定した投稿処理
- 重複コンテンツの削減によるシステムとユーザー体験の改善
- 設定の柔軟性による様々なユースケースへの対応
